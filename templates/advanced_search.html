{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2 class="mb-4">Advanced Search</h2>

    <div class="advanced-search-form">
        <form id="advancedSearchForm">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="name" class="form-label">Company Name</label>
                    <input type="text" class="form-control" id="name" name="name">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="industry" class="form-label">Industry</label>
                    <input type="text" class="form-control" id="industry" name="industry">
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="status" class="form-label">Collaboration Status</label>
                    <select class="form-select" id="status" name="status">
                        <option value="">Any</option>
                        <option value="Active">Active</option>
                        <option value="Completed">Completed</option>
                        <option value="On Hold">On Hold</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="pipeline_stage" class="form-label">Pipeline Stage</label>
                    <select class="form-select" id="pipeline_stage" name="pipeline_stage">
                        <option value="">Any</option>
                        <option value="Lead">Lead</option>
                        <option value="Meeting">Meeting</option>
                        <option value="Proposal">Proposal</option>
                        <option value="Negotiation">Negotiation</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Revenue Range ($)</label>
                    <div class="row">
                        <div class="col">
                            <input type="number" class="form-control" id="min_revenue" name="min_revenue" placeholder="Min">
                        </div>
                        <div class="col">
                            <input type="number" class="form-control" id="max_revenue" name="max_revenue" placeholder="Max">
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Satisfaction Score (1-10)</label>
                    <div class="row">
                        <div class="col">
                            <input type="number" class="form-control" id="min_satisfaction" name="min_satisfaction" placeholder="Min" min="1" max="10">
                        </div>
                        <div class="col">
                            <input type="number" class="form-control" id="max_satisfaction" name="max_satisfaction" placeholder="Max" min="1" max="10">
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-primary">Search</button>
                <button type="reset" class="btn btn-secondary ms-2">Reset</button>
            </div>
        </form>
    </div>

    <div class="advanced-search-results">
        <div id="searchResults" class="row g-4">
            <!-- Results will be dynamically populated here -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('advancedSearchForm');
    const resultsContainer = document.getElementById('searchResults');

    searchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(searchForm);
        const params = new URLSearchParams();

        for (const [key, value] of formData.entries()) {
            if (value) params.append(key, value);
        }

        try {
            const response = await fetch(`/api/advanced-search?${params.toString()}`);
            const results = await response.json();

            if (results.error) {
                resultsContainer.innerHTML = `<div class="col-12"><div class="alert alert-danger">${results.error}</div></div>`;
                return;
            }

            if (results.length === 0) {
                resultsContainer.innerHTML = `<div class="col-12"><div class="alert alert-info">No results found</div></div>`;
                return;
            }

            resultsContainer.innerHTML = results.map(company => `
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">${company.name}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">${company.industry}</h6>
                            
                            ${company.latest_collaboration ? `
                                <div class="mt-3">
                                    <h6 class="mb-2">Latest Collaboration</h6>
                                    <p class="card-text mb-1">${company.latest_collaboration.title}</p>
                                    <span class="badge bg-${getStatusBadgeClass(company.latest_collaboration.status)}">${company.latest_collaboration.status}</span>
                                    <div class="progress mt-2" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" style="width: ${company.latest_collaboration.satisfaction * 10}%">
                                            Satisfaction: ${company.latest_collaboration.satisfaction}/10
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${company.latest_opportunity ? `
                                <div class="mt-3">
                                    <h6 class="mb-2">Latest Opportunity</h6>
                                    <p class="card-text mb-1">${company.latest_opportunity.title}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-primary">${company.latest_opportunity.stage}</span>
                                        <span class="badge bg-info">${company.latest_opportunity.probability}%</span>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="card-footer">
                            <a href="/company/${company.id}" class="btn btn-primary btn-sm">View Details</a>
                        </div>
                    </div>
                </div>
            `).join('');

        } catch (error) {
            console.error('Search error:', error);
            resultsContainer.innerHTML = `<div class="col-12"><div class="alert alert-danger">Error performing search</div></div>`;
        }
    });

    function getStatusBadgeClass(status) {
        switch (status) {
            case 'Active': return 'success';
            case 'Completed': return 'primary';
            case 'On Hold': return 'warning';
            default: return 'secondary';
        }
    }
});
</script>
{% endblock %}
